import { getId } from '../../src/feed/handler'
import { Epoch } from '../../src/feed/lookup/epoch'

describe('handler', () => {
  const epochIdExamples = [
    {
      time: 0,
      level: 31,
      result: [0, 0, 0, 0, 0, 0, 0, 31],
    },
    {
      time: 1647854933,
      level: 31,
      result: [0, 0, 0, 0, 0, 0, 0, 31],
    },
    {
      time: -1,
      level: 31,
      result: [0, 0, 0, 128, 255, 255, 255, 31],
    },
    {
      time: 1647854945,
      level: 30,
      result: [0, 0, 0, 64, 0, 0, 0, 30],
    },
    {
      time: 1647854945,
      level: 29,
      result: [0, 0, 0, 96, 0, 0, 0, 29],
    },
    {
      time: 1647854945,
      level: 28,
      result: [0, 0, 0, 96, 0, 0, 0, 28],
    },
    {
      time: 1647854945,
      level: 27,
      result: [0, 0, 0, 96, 0, 0, 0, 27],
    },
    {
      time: 1647854945,
      level: 26,
      result: [0, 0, 0, 96, 0, 0, 0, 26],
    },
    {
      time: 1647854945,
      level: 25,
      result: [0, 0, 0, 98, 0, 0, 0, 25],
    },
    {
      time: 1647854945,
      level: 24,
      result: [0, 0, 0, 98, 0, 0, 0, 24],
    },
    {
      time: 1647854945,
      level: 23,
      result: [0, 0, 0, 98, 0, 0, 0, 23],
    },
    {
      time: 1647854945,
      level: 22,
      result: [0, 0, 0, 98, 0, 0, 0, 22],
    },
    {
      time: 1647854945,
      level: 21,
      result: [0, 0, 32, 98, 0, 0, 0, 21],
    },
    {
      time: 1647854945,
      level: 20,
      result: [0, 0, 48, 98, 0, 0, 0, 20],
    },
    {
      time: 1647312895,
      level: 20,
      result: [0, 0, 32, 98, 0, 0, 0, 20],
    },
  ]

  const getIdExamples = [
    {
      topic: [
        64, 204, 28, 115, 118, 249, 155, 237, 72, 58, 107, 35, 175, 52, 190, 5, 239, 154, 78, 248, 209, 32, 157, 135,
        105, 253, 50, 207, 182, 78, 146, 64,
      ],
      time: 0,
      level: 31,
      result: [
        192, 199, 235, 193, 4, 30, 150, 71, 114, 55, 81, 241, 36, 4, 167, 21, 11, 203, 97, 51, 192, 41, 85, 83, 26, 196,
        220, 74, 172, 129, 230, 145,
      ],
    },
    {
      topic: [
        24, 27, 140, 121, 96, 181, 58, 175, 234, 43, 166, 170, 208, 48, 75, 252, 71, 180, 210, 93, 153, 252, 106, 131,
        132, 33, 215, 114, 245, 100, 28, 40,
      ],
      time: 0,
      level: 31,
      result: [
        33, 152, 66, 62, 214, 250, 233, 47, 80, 227, 143, 184, 49, 194, 68, 62, 86, 72, 251, 251, 255, 109, 199, 93,
        139, 156, 147, 136, 113, 94, 106, 14,
      ],
    },
    {
      topic: [
        124, 237, 150, 108, 146, 146, 147, 126, 14, 137, 106, 40, 21, 237, 31, 27, 213, 193, 32, 204, 111, 223, 197,
        122, 243, 120, 93, 99, 52, 160, 0, 213,
      ],
      time: 0,
      level: 31,
      result: [
        78, 50, 123, 238, 90, 128, 131, 200, 147, 25, 242, 75, 191, 72, 114, 82, 159, 81, 221, 17, 172, 22, 113, 201,
        129, 67, 224, 22, 0, 73, 115, 96,
      ],
    },
    {
      topic: [
        124, 237, 150, 108, 146, 146, 147, 126, 14, 137, 106, 40, 21, 237, 31, 27, 213, 193, 32, 204, 111, 223, 197,
        122, 243, 120, 93, 99, 52, 160, 0, 213,
      ],
      time: 0,
      level: 31,
      result: [
        78, 50, 123, 238, 90, 128, 131, 200, 147, 25, 242, 75, 191, 72, 114, 82, 159, 81, 221, 17, 172, 22, 113, 201,
        129, 67, 224, 22, 0, 73, 115, 96,
      ],
    },
    {
      topic: [
        115, 104, 177, 56, 197, 91, 66, 71, 36, 184, 147, 109, 166, 236, 226, 198, 102, 31, 42, 1, 203, 204, 186, 68,
        57, 38, 4, 87, 31, 104, 224, 87,
      ],
      time: 0,
      level: 31,
      result: [
        206, 136, 204, 81, 249, 114, 10, 71, 213, 152, 130, 20, 37, 235, 20, 17, 80, 169, 195, 156, 159, 27, 12, 16,
        230, 128, 181, 85, 118, 123, 199, 218,
      ],
    },
    {
      topic: [
        251, 51, 96, 181, 78, 11, 83, 157, 91, 6, 24, 99, 32, 249, 90, 40, 168, 207, 146, 153, 183, 230, 123, 241, 208,
        217, 187, 51, 169, 13, 67, 81,
      ],
      time: 0,
      level: 31,
      result: [
        253, 205, 215, 201, 10, 147, 239, 210, 118, 22, 30, 253, 27, 13, 194, 95, 235, 234, 36, 100, 54, 46, 236, 68,
        186, 16, 239, 185, 176, 134, 78, 164,
      ],
    },
    {
      topic: [
        234, 80, 91, 18, 22, 125, 6, 133, 45, 237, 137, 2, 230, 132, 242, 159, 19, 214, 179, 237, 140, 0, 142, 62, 83,
        160, 62, 50, 182, 5, 201, 247,
      ],
      time: 0,
      level: 31,
      result: [
        119, 22, 217, 89, 177, 127, 217, 230, 83, 0, 238, 71, 243, 141, 219, 57, 174, 63, 220, 142, 131, 207, 243, 143,
        44, 117, 191, 238, 171, 38, 181, 104,
      ],
    },
    {
      topic: [
        234, 80, 91, 18, 22, 125, 6, 133, 45, 237, 137, 2, 230, 132, 242, 159, 19, 214, 179, 237, 140, 0, 142, 62, 83,
        160, 62, 50, 182, 5, 201, 247,
      ],
      time: 0,
      level: 31,
      result: [
        119, 22, 217, 89, 177, 127, 217, 230, 83, 0, 238, 71, 243, 141, 219, 57, 174, 63, 220, 142, 131, 207, 243, 143,
        44, 117, 191, 238, 171, 38, 181, 104,
      ],
    },
    {
      topic: [
        115, 104, 177, 56, 197, 91, 66, 71, 36, 184, 147, 109, 166, 236, 226, 198, 102, 31, 42, 1, 203, 204, 186, 68,
        57, 38, 4, 87, 31, 104, 224, 87,
      ],
      time: 0,
      level: 31,
      result: [
        206, 136, 204, 81, 249, 114, 10, 71, 213, 152, 130, 20, 37, 235, 20, 17, 80, 169, 195, 156, 159, 27, 12, 16,
        230, 128, 181, 85, 118, 123, 199, 218,
      ],
    },
    {
      topic: [
        251, 51, 96, 181, 78, 11, 83, 157, 91, 6, 24, 99, 32, 249, 90, 40, 168, 207, 146, 153, 183, 230, 123, 241, 208,
        217, 187, 51, 169, 13, 67, 81,
      ],
      time: 0,
      level: 31,
      result: [
        253, 205, 215, 201, 10, 147, 239, 210, 118, 22, 30, 253, 27, 13, 194, 95, 235, 234, 36, 100, 54, 46, 236, 68,
        186, 16, 239, 185, 176, 134, 78, 164,
      ],
    },
    {
      topic: [
        115, 104, 177, 56, 197, 91, 66, 71, 36, 184, 147, 109, 166, 236, 226, 198, 102, 31, 42, 1, 203, 204, 186, 68,
        57, 38, 4, 87, 31, 104, 224, 87,
      ],
      time: 0,
      level: 31,
      result: [
        206, 136, 204, 81, 249, 114, 10, 71, 213, 152, 130, 20, 37, 235, 20, 17, 80, 169, 195, 156, 159, 27, 12, 16,
        230, 128, 181, 85, 118, 123, 199, 218,
      ],
    },
    {
      topic: [
        121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50, 76,
        203, 46, 58, 189, 192, 88, 5, 62,
      ],
      time: 1647862022,
      level: 31,
      result: [
        207, 41, 219, 83, 213, 196, 65, 130, 180, 200, 178, 34, 177, 224, 3, 110, 180, 139, 190, 221, 59, 96, 135, 174,
        128, 66, 110, 158, 39, 87, 116, 170,
      ],
    },
    {
      topic: [
        212, 174, 15, 137, 87, 128, 211, 60, 207, 212, 54, 252, 168, 102, 244, 154, 165, 101, 197, 157, 71, 6, 123, 26,
        32, 229, 18, 119, 213, 153, 173, 141,
      ],
      time: 0,
      level: 31,
      result: [
        89, 210, 219, 4, 139, 95, 193, 117, 77, 224, 198, 71, 179, 50, 253, 116, 44, 48, 209, 193, 37, 205, 110, 44,
        195, 104, 114, 192, 242, 109, 21, 33,
      ],
    },
    {
      topic: [
        121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50, 76,
        203, 46, 58, 189, 192, 88, 5, 62,
      ],
      time: 1647862034,
      level: 31,
      result: [
        207, 41, 219, 83, 213, 196, 65, 130, 180, 200, 178, 34, 177, 224, 3, 110, 180, 139, 190, 221, 59, 96, 135, 174,
        128, 66, 110, 158, 39, 87, 116, 170,
      ],
    },
    {
      topic: [
        121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50, 76,
        203, 46, 58, 189, 192, 88, 5, 62,
      ],
      time: 1647862034,
      level: 25,
      result: [
        60, 20, 31, 3, 74, 240, 186, 225, 95, 128, 3, 45, 78, 174, 68, 80, 244, 167, 163, 92, 79, 203, 160, 248, 189,
        126, 27, 232, 220, 32, 247, 91,
      ],
    },
    {
      topic: [
        121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50, 76,
        203, 46, 58, 189, 192, 88, 5, 62,
      ],
      time: 1647862034,
      level: 24,
      result: [
        30, 71, 181, 179, 118, 145, 132, 97, 217, 248, 190, 200, 120, 13, 52, 120, 115, 53, 93, 63, 103, 106, 135, 118,
        155, 159, 77, 77, 207, 65, 185, 153,
      ],
    },
    {
      topic: [
        121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50, 76,
        203, 46, 58, 189, 192, 88, 5, 62,
      ],
      time: 1647862034,
      level: 23,
      result: [
        93, 12, 120, 127, 134, 93, 56, 142, 245, 13, 169, 57, 202, 121, 133, 160, 232, 127, 36, 27, 141, 145, 88, 166,
        175, 2, 201, 219, 46, 254, 92, 140,
      ],
    },
    {
      topic: [
        121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50, 76,
        203, 46, 58, 189, 192, 88, 5, 62,
      ],
      time: 1647862034,
      level: 22,
      result: [
        46, 185, 143, 15, 139, 48, 92, 198, 215, 116, 32, 223, 40, 114, 54, 140, 27, 206, 13, 153, 235, 201, 118, 163,
        241, 208, 48, 91, 127, 95, 142, 153,
      ],
    },
    {
      topic: [
        121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50, 76,
        203, 46, 58, 189, 192, 88, 5, 62,
      ],
      time: 1647862034,
      level: 21,
      result: [
        246, 20, 183, 223, 195, 172, 31, 24, 1, 194, 140, 87, 192, 225, 16, 12, 198, 109, 252, 126, 144, 14, 176, 210,
        11, 49, 4, 53, 40, 32, 11, 181,
      ],
    },
    {
      topic: [
        121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50, 76,
        203, 46, 58, 189, 192, 88, 5, 62,
      ],
      time: 1647862034,
      level: 20,
      result: [
        124, 116, 161, 57, 208, 190, 137, 48, 82, 15, 159, 154, 235, 252, 20, 82, 67, 193, 253, 158, 31, 79, 50, 182,
        150, 117, 115, 148, 179, 160, 252, 120,
      ],
    },
    {
      topic: [
        121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50, 76,
        203, 46, 58, 189, 192, 88, 5, 62,
      ],
      time: 1647312895,
      level: 20,
      result: [
        230, 88, 42, 172, 164, 128, 33, 134, 252, 63, 0, 166, 90, 24, 246, 133, 197, 5, 132, 67, 175, 255, 209, 196,
        116, 48, 164, 206, 174, 222, 233, 123,
      ],
    },
  ]

  it('epochId', () => {
    for (const example of epochIdExamples) {
      const epoch = new Epoch(example.level, example.time)
      const result = epoch.id()
      expect(result.length).toEqual(8)
      expect(result.toString()).toEqual(example.result.toString())
    }
  })

  it('getId', () => {
    for (const example of getIdExamples) {
      const result = getId(new Uint8Array(example.topic), example.time, example.level)
      expect(result.length).toEqual(32)
      expect(result.toString().split(',').map(Number)).toEqual(example.result)
    }
  })
})
