import { getId } from '../../src/feed/handler'
import { Epoch } from '../../src/feed/lookup/epoch'
import { numbersToSegment } from '../utils'

describe('handler', () => {
  it('epochId', () => {
    const examples = [
      {
        time: 0,
        level: 31,
        result: [0, 0, 0, 0, 0, 0, 0, 31],
      },
      {
        time: 1647854933,
        level: 31,
        result: [0, 0, 0, 0, 0, 0, 0, 31],
      },
      {
        time: -1,
        level: 31,
        result: [0, 0, 0, 128, 255, 255, 255, 31],
      },
      {
        time: 1647854945,
        level: 30,
        result: [0, 0, 0, 64, 0, 0, 0, 30],
      },
      {
        time: 1647854945,
        level: 29,
        result: [0, 0, 0, 96, 0, 0, 0, 29],
      },
      {
        time: 1647854945,
        level: 28,
        result: [0, 0, 0, 96, 0, 0, 0, 28],
      },
      {
        time: 1647854945,
        level: 27,
        result: [0, 0, 0, 96, 0, 0, 0, 27],
      },
      {
        time: 1647854945,
        level: 26,
        result: [0, 0, 0, 96, 0, 0, 0, 26],
      },
      {
        time: 1647854945,
        level: 25,
        result: [0, 0, 0, 98, 0, 0, 0, 25],
      },
      {
        time: 1647854945,
        level: 24,
        result: [0, 0, 0, 98, 0, 0, 0, 24],
      },
      {
        time: 1647854945,
        level: 23,
        result: [0, 0, 0, 98, 0, 0, 0, 23],
      },
      {
        time: 1647854945,
        level: 22,
        result: [0, 0, 0, 98, 0, 0, 0, 22],
      },
      {
        time: 1647854945,
        level: 21,
        result: [0, 0, 32, 98, 0, 0, 0, 21],
      },
      {
        time: 1647854945,
        level: 20,
        result: [0, 0, 48, 98, 0, 0, 0, 20],
      },
      {
        time: 1647312895,
        level: 20,
        result: [0, 0, 32, 98, 0, 0, 0, 20],
      },
    ]
    for (const example of examples) {
      const epoch = new Epoch(example.level, example.time)
      const result = epoch.id()
      expect(result.length).toEqual(8)
      expect(result.toString()).toEqual(example.result.toString())
    }
  })

  it('getId', () => {
    const examples = [
      {
        topic: [
          64, 204, 28, 115, 118, 249, 155, 237, 72, 58, 107, 35, 175, 52, 190, 5, 239, 154, 78, 248, 209, 32, 157, 135,
          105, 253, 50, 207, 182, 78, 146, 64,
        ],
        time: 0,
        level: 31,
        result: [
          137, 19, 193, 4, 187, 223, 87, 230, 131, 174, 71, 54, 179, 192, 170, 137, 115, 200, 208, 8, 48, 130, 231, 58,
          27, 125, 244, 100, 224, 149, 0, 106,
        ],
      },
      {
        topic: [
          24, 27, 140, 121, 96, 181, 58, 175, 234, 43, 166, 170, 208, 48, 75, 252, 71, 180, 210, 93, 153, 252, 106, 131,
          132, 33, 215, 114, 245, 100, 28, 40,
        ],
        time: 0,
        level: 31,
        result: [
          96, 40, 10, 151, 168, 195, 183, 128, 50, 255, 205, 132, 115, 176, 20, 201, 179, 95, 199, 161, 154, 75, 149,
          246, 158, 47, 158, 144, 245, 92, 164, 125,
        ],
      },
      {
        topic: [
          124, 237, 150, 108, 146, 146, 147, 126, 14, 137, 106, 40, 21, 237, 31, 27, 213, 193, 32, 204, 111, 223, 197,
          122, 243, 120, 93, 99, 52, 160, 0, 213,
        ],
        time: 0,
        level: 31,
        result: [
          232, 154, 186, 138, 160, 29, 85, 104, 241, 2, 110, 46, 106, 24, 253, 196, 147, 65, 143, 93, 88, 178, 30, 200,
          81, 100, 30, 212, 2, 86, 16, 148,
        ],
      },
      {
        topic: [
          124, 237, 150, 108, 146, 146, 147, 126, 14, 137, 106, 40, 21, 237, 31, 27, 213, 193, 32, 204, 111, 223, 197,
          122, 243, 120, 93, 99, 52, 160, 0, 213,
        ],
        time: 0,
        level: 31,
        result: [
          232, 154, 186, 138, 160, 29, 85, 104, 241, 2, 110, 46, 106, 24, 253, 196, 147, 65, 143, 93, 88, 178, 30, 200,
          81, 100, 30, 212, 2, 86, 16, 148,
        ],
      },
      {
        topic: [
          115, 104, 177, 56, 197, 91, 66, 71, 36, 184, 147, 109, 166, 236, 226, 198, 102, 31, 42, 1, 203, 204, 186, 68,
          57, 38, 4, 87, 31, 104, 224, 87,
        ],
        time: 0,
        level: 31,
        result: [
          224, 229, 31, 229, 74, 157, 228, 135, 101, 165, 181, 236, 240, 16, 28, 251, 67, 151, 183, 77, 61, 190, 173,
          192, 116, 112, 222, 238, 14, 150, 231, 45,
        ],
      },
      {
        topic: [
          251, 51, 96, 181, 78, 11, 83, 157, 91, 6, 24, 99, 32, 249, 90, 40, 168, 207, 146, 153, 183, 230, 123, 241,
          208, 217, 187, 51, 169, 13, 67, 81,
        ],
        time: 0,
        level: 31,
        result: [
          29, 196, 17, 153, 124, 114, 151, 22, 166, 28, 67, 214, 195, 74, 176, 2, 128, 150, 20, 239, 115, 127, 95, 213,
          32, 206, 46, 115, 104, 68, 53, 26,
        ],
      },
      {
        topic: [
          234, 80, 91, 18, 22, 125, 6, 133, 45, 237, 137, 2, 230, 132, 242, 159, 19, 214, 179, 237, 140, 0, 142, 62, 83,
          160, 62, 50, 182, 5, 201, 247,
        ],
        time: 0,
        level: 31,
        result: [
          105, 227, 231, 100, 44, 42, 103, 134, 253, 119, 46, 159, 50, 218, 232, 189, 84, 64, 4, 196, 36, 58, 40, 82,
          210, 83, 37, 120, 29, 90, 14, 23,
        ],
      },
      {
        topic: [
          234, 80, 91, 18, 22, 125, 6, 133, 45, 237, 137, 2, 230, 132, 242, 159, 19, 214, 179, 237, 140, 0, 142, 62, 83,
          160, 62, 50, 182, 5, 201, 247,
        ],
        time: 0,
        level: 31,
        result: [
          105, 227, 231, 100, 44, 42, 103, 134, 253, 119, 46, 159, 50, 218, 232, 189, 84, 64, 4, 196, 36, 58, 40, 82,
          210, 83, 37, 120, 29, 90, 14, 23,
        ],
      },
      {
        topic: [
          115, 104, 177, 56, 197, 91, 66, 71, 36, 184, 147, 109, 166, 236, 226, 198, 102, 31, 42, 1, 203, 204, 186, 68,
          57, 38, 4, 87, 31, 104, 224, 87,
        ],
        time: 0,
        level: 31,
        result: [
          224, 229, 31, 229, 74, 157, 228, 135, 101, 165, 181, 236, 240, 16, 28, 251, 67, 151, 183, 77, 61, 190, 173,
          192, 116, 112, 222, 238, 14, 150, 231, 45,
        ],
      },
      {
        topic: [
          251, 51, 96, 181, 78, 11, 83, 157, 91, 6, 24, 99, 32, 249, 90, 40, 168, 207, 146, 153, 183, 230, 123, 241,
          208, 217, 187, 51, 169, 13, 67, 81,
        ],
        time: 0,
        level: 31,
        result: [
          29, 196, 17, 153, 124, 114, 151, 22, 166, 28, 67, 214, 195, 74, 176, 2, 128, 150, 20, 239, 115, 127, 95, 213,
          32, 206, 46, 115, 104, 68, 53, 26,
        ],
      },
      {
        topic: [
          115, 104, 177, 56, 197, 91, 66, 71, 36, 184, 147, 109, 166, 236, 226, 198, 102, 31, 42, 1, 203, 204, 186, 68,
          57, 38, 4, 87, 31, 104, 224, 87,
        ],
        time: 0,
        level: 31,
        result: [
          224, 229, 31, 229, 74, 157, 228, 135, 101, 165, 181, 236, 240, 16, 28, 251, 67, 151, 183, 77, 61, 190, 173,
          192, 116, 112, 222, 238, 14, 150, 231, 45,
        ],
      },
      {
        topic: [
          121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50,
          76, 203, 46, 58, 189, 192, 88, 5, 62,
        ],
        time: 1647862022,
        level: 31,
        result: [
          226, 61, 113, 161, 213, 84, 251, 42, 70, 128, 28, 110, 124, 221, 125, 52, 241, 59, 79, 83, 231, 163, 171, 145,
          3, 90, 242, 32, 8, 59, 83, 250,
        ],
      },
      {
        topic: [
          212, 174, 15, 137, 87, 128, 211, 60, 207, 212, 54, 252, 168, 102, 244, 154, 165, 101, 197, 157, 71, 6, 123,
          26, 32, 229, 18, 119, 213, 153, 173, 141,
        ],
        time: 0,
        level: 31,
        result: [
          43, 225, 162, 162, 82, 69, 80, 236, 180, 162, 109, 230, 25, 127, 64, 179, 24, 87, 207, 63, 157, 95, 51, 175,
          43, 61, 77, 51, 167, 166, 170, 242,
        ],
      },
      {
        topic: [
          121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50,
          76, 203, 46, 58, 189, 192, 88, 5, 62,
        ],
        time: 1647862034,
        level: 31,
        result: [
          226, 61, 113, 161, 213, 84, 251, 42, 70, 128, 28, 110, 124, 221, 125, 52, 241, 59, 79, 83, 231, 163, 171, 145,
          3, 90, 242, 32, 8, 59, 83, 250,
        ],
      },
      {
        topic: [
          121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50,
          76, 203, 46, 58, 189, 192, 88, 5, 62,
        ],
        time: 1647862034,
        level: 25,
        result: [
          191, 233, 150, 32, 204, 164, 167, 185, 150, 21, 29, 120, 78, 56, 133, 11, 11, 114, 125, 27, 11, 112, 142, 93,
          203, 41, 56, 206, 194, 117, 158, 161,
        ],
      },
      {
        topic: [
          121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50,
          76, 203, 46, 58, 189, 192, 88, 5, 62,
        ],
        time: 1647862034,
        level: 24,
        result: [
          159, 94, 207, 0, 185, 61, 37, 206, 170, 1, 158, 43, 20, 243, 185, 38, 40, 130, 233, 206, 35, 3, 229, 195, 192,
          145, 55, 48, 188, 112, 252, 181,
        ],
      },
      {
        topic: [
          121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50,
          76, 203, 46, 58, 189, 192, 88, 5, 62,
        ],
        time: 1647862034,
        level: 23,
        result: [
          246, 157, 148, 197, 225, 67, 186, 35, 17, 2, 185, 128, 240, 110, 242, 10, 134, 55, 50, 16, 160, 229, 128, 152,
          218, 218, 36, 28, 184, 224, 163, 150,
        ],
      },
      {
        topic: [
          121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50,
          76, 203, 46, 58, 189, 192, 88, 5, 62,
        ],
        time: 1647862034,
        level: 22,
        result: [
          193, 236, 34, 45, 89, 227, 46, 168, 161, 107, 87, 54, 118, 118, 177, 57, 239, 159, 46, 92, 39, 193, 127, 45,
          105, 40, 175, 49, 42, 181, 135, 186,
        ],
      },
      {
        topic: [
          121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50,
          76, 203, 46, 58, 189, 192, 88, 5, 62,
        ],
        time: 1647862034,
        level: 21,
        result: [
          59, 242, 121, 83, 124, 83, 249, 32, 67, 214, 142, 30, 140, 147, 109, 90, 86, 210, 178, 110, 240, 110, 148,
          136, 180, 45, 124, 90, 124, 112, 114, 61,
        ],
      },
      {
        topic: [
          121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50,
          76, 203, 46, 58, 189, 192, 88, 5, 62,
        ],
        time: 1647862034,
        level: 20,
        result: [
          69, 233, 198, 244, 94, 12, 108, 53, 125, 82, 215, 223, 200, 203, 204, 205, 225, 79, 37, 237, 91, 232, 227,
          117, 64, 72, 15, 94, 150, 214, 237, 136,
        ],
      },
      {
        topic: [
          121, 107, 80, 110, 72, 254, 149, 57, 177, 254, 155, 240, 133, 53, 67, 179, 147, 22, 236, 127, 186, 245, 50,
          76, 203, 46, 58, 189, 192, 88, 5, 62,
        ],
        time: 1647312895,
        level: 20,
        result: [
          142, 93, 254, 156, 169, 52, 41, 244, 1, 178, 180, 2, 22, 140, 205, 145, 51, 115, 170, 178, 80, 74, 213, 233,
          217, 121, 212, 97, 116, 226, 204, 159,
        ],
      },
    ]
    for (const example of examples) {
      const result = getId(numbersToSegment(example.topic), example.time, example.level)
      expect(result.length).toEqual(32)
      const calculatedResult = result.toString().split(',').map(Number)
      expect(calculatedResult).toEqual(example.result)
    }
  })
})
